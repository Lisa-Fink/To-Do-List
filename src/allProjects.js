import { todoLists } from "./classes";
import projectControl from "./projectPage";
import { contentController} from ".";
import { sideRender, sideControl } from "./sideProjects";

const makeIcon = (name) => {
    const span = document.createElement('span');
    span.classList.add('material-symbols-outlined');
    span.innerText = name;
    return span;
};

const allProjControl = (() => {
    const makePage = () => {
        allProjRender.page();
    }
    const projFunctions = (e) => {
        const projectClicked = e.target.parentElement.parentElement.data;
        const funcClicked =  e.target.data;
        if (funcClicked == 'view') {
            viewProject(projectClicked);
        } else if (funcClicked == 'rename') {
            renameProject(projectClicked, e);
        } else if (funcClicked == 'delete') {
            deleteProject(projectClicked);
        }
    }
    const viewProject = (project) => {
        contentController.goToProjectPage(project);
    }
    const renameProject = (project, e) => {
        const h3 = e.target.parentElement.parentElement.firstChild
        allProjRender.changeToInput(project, h3)
    }
    const deleteProject = (project) => {
        todoLists.removeProject(todoLists.getIndex(project));
        sideRender.update();
    }

    const makeEdit = (e) => {
        const projClicked = e.target.parentElement.parentElement.parentElement.parentElement.data;
        const newName = e.target.parentElement.parentElement[0].value;
        projClicked.name = newName == '' ? 'unnamed project' : newName;
        sideRender.update();
    }
    const cancelEdit = () => {
        allProjRender.update();
    }
    const cancelForm = () => {
        const input = document.getElementById('all-proj-name-input');
        input.value = '';
        cancelEdit();
    }

    return {makePage, viewProject, projFunctions, makeEdit, cancelEdit, cancelForm};
})()

const allProjCreate = (() => {
    const heading = () => { 
        const head = document.createElement('h2');
        head.innerText = 'My Projects';
        return head;
        }
    const inputForm = (project) => {
        const form = document.createElement('form');
        form.style.display = 'flex';
        const nameInput = document.createElement('textarea');
        nameInput.value = project.name;

        const buttonDiv = document.createElement('div');
        buttonDiv.id = 'project-input-buttons'

        const check = makeIcon('check_circle');
        const cancel = makeIcon('cancel');
        check.addEventListener('click', allProjControl.makeEdit);
        cancel.addEventListener('click', allProjControl.cancelEdit);
        buttonDiv.appendChild(check);
        buttonDiv.appendChild(cancel);

        form.appendChild(nameInput);
        form.appendChild(buttonDiv);
        return form;
    }
    const projList = () => {
        const projectUl = document.createElement('ul');
        projectUl.id = 'all-proj-ul'
        todoLists.projects.forEach(project => {
            projectUl.appendChild(projCard(project));
        })
        return projectUl;
    }
    const projCard = (project) => {
        let li = document.createElement('li');
        li.data = project;
        li.classList.add('proj-card');

        const projHead = document.createElement('h3');
        projHead.innerText = project.name.length < 29 ? project.name: 
            `${project.name.slice(0,28)}...`;

        const projItems = document.createElement('p');
        projItems.innerText = `${project.todos.length} tasks`;

        const projLink = document.createElement('div');
        projLink.id = 'proj-links';
        const view = makeIcon('open_in_new');
        view.data = 'view';
        const rename = makeIcon('edit');
        rename.data = 'rename';
        const del = makeIcon('delete_forever');
        del.data = 'delete';

        const topDiv = document.createElement('div');
        
        projLink.appendChild(view);
        projLink.appendChild(rename);
        projLink.appendChild(del);
        projLink.addEventListener('click', allProjControl.projFunctions);

        topDiv.appendChild(projHead);
        topDiv.appendChild(projItems);
        li.appendChild(topDiv);
        li.appendChild(projLink);
        return li;
    }
    const addProject = () => {
        const addProject = document.createElement('div');
        addProject.innerText = 'Add Project ';
        addProject.appendChild(makeIcon('add_circle'));
        addProject.addEventListener('click', allProjRender.showForm);
        addProject.id = 'add-project-main'
        return addProject;
    }
    const addProjectForm = () => {
        const addDiv = document.createElement('div');
        addDiv.id = 'add-project-form'

        const projFormHeading = document.createElement('h3');
        projFormHeading.innerText = 'Create a New Project'

        const input = document.createElement('input');
        input.id = 'all-proj-name-input';
        input.placeholder = 'Enter Project Name';

        const buttons = document.createElement('div');
        const check = makeIcon('check_circle');
        const cancel = makeIcon('cancel');
        check.addEventListener('click', sideControl.makeNewProject);
        cancel.addEventListener('click', allProjControl.cancelForm);
        buttons.appendChild(check);
        buttons.appendChild(cancel);

        addDiv.appendChild(projFormHeading);
        addDiv.appendChild(input);
        addDiv.appendChild(buttons);
        return addDiv;
    }
    return {projList, heading, inputForm, addProject, addProjectForm};
})()

const allProjRender = (() => {
    const changeToInput = (project, toBeChanged) => {
        toBeChanged.innerHTML = ''
        toBeChanged.appendChild(allProjCreate.inputForm(project));
    }
    const page = () => {
        const contentDiv = document.getElementById('main-content');
        contentDiv.data = 'all-projects'
        contentDiv.innerHTML = '';
        const allProjContainer = document.createElement('div');
        allProjContainer.id = 'all-proj-container';
        contentDiv.appendChild(allProjContainer);
        allProjContainer.appendChild(allProjCreate.heading());
        allProjContainer.appendChild(allProjCreate.addProjectForm());
        allProjContainer.appendChild(allProjCreate.addProject());
        allProjContainer.appendChild(allProjCreate.projList());
    }
    const update = () => {
        const addProj = document.getElementById('add-project-main')
        addProj && addProj.style.display != 'block' ? 
            addProj.style.display = 'none' : null;
        page()
        todoLists.updateStorage();
    }
    const showForm = () => {
        const addProj = document.getElementById('add-project-main')
        addProj.style.display = 'none'
        const form = document.getElementById('add-project-form');
        form.style.display = 'block'
    }
    return {page, update, changeToInput, showForm};
})()

export {allProjControl, allProjRender, makeIcon};